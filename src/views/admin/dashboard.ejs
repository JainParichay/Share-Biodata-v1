<%- include('../partials/header') %>

<div class="flex h-screen bg-gray-100">
  <!-- Sidebar is critical, load immediately -->
  <%- include('./island/Sidebar') %>

  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Main Content -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-200">
      <div class="container mx-auto px-6 py-8">
        <!-- Stats Cards Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <%- include('../components/LazyLoader', { component:
          'admin/StatsCard', props: { title: 'Total Users', value: '1,234',
          icon: 'users' } }) %> <%- include('../components/LazyLoader', {
          component: 'admin/StatsCard', props: { title: 'Total Files', value:
          '567', icon: 'files' } }) %> <%- include('../components/LazyLoader', {
          component: 'admin/StatsCard', props: { title: 'Total Files', value:
          '567', icon: 'files' } }) %>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-lg shadow mb-8">
          <%- include('../components/LazyLoader', { component:
          'admin/RecentActivity', props: {} }) %>
        </div>

        <!-- Quick Actions and Notifications -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <%- include('../components/LazyLoader', { component:
          'admin/QuickActions', props: {} }) %> <%-
          include('../components/LazyLoader', { component:
          'admin/Notifications', props: {} }) %>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Add this before closing body tag -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const componentToken = "<%= componentToken %>"; // Get token from server

    const loadComponent = async (element) => {
      const component = element.dataset.component;
      const props = JSON.parse(
        decodeURIComponent(element.dataset.props || "{}")
      );

      try {
        const response = await fetch(`/api/components/${component}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Component-Token": componentToken,
          },
          body: JSON.stringify(props),
          credentials: "include", // Changed from same-origin to include
        });

        if (response.ok) {
          const html = await response.text();
          element.innerHTML = html;
        } else if (response.status === 401) {
          // Handle unauthorized access
          window.location.href = "/auth/login";
        } else {
          throw new Error(`Failed to load component: ${response.status}`);
        }
      } catch (error) {
        console.error("Error loading component:", error);
        element.innerHTML =
          '<div class="text-red-500 p-4">Failed to load component</div>';
      }
    };

    // Load components when they become visible
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            loadComponent(entry.target);
            observer.unobserve(entry.target);
          }
        });
      },
      { rootMargin: "50px" }
    );

    // Observe all lazy components
    document.querySelectorAll(".lazy-component").forEach((component) => {
      observer.observe(component);
    });
  });
</script>

<%- include('../partials/footer') %>
